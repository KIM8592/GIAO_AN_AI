<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI So·∫°n B√†i - TH Kh√°nh B√¨nh</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
    body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
    
    /* ƒê√É S·ª¨A: L·ªÅ chu·∫©n Th√¥ng t∆∞: Tr√°i 3cm, Ph·∫£i 1.5cm, Tr√™n/D∆∞·ªõi 2cm */
    .word-content { 
        width: 21cm; 
        min-height: 29.7cm; 
        padding-top: 2cm; 
        padding-bottom: 2cm; 
        padding-left: 3cm; 
        padding-right: 1.5cm; 
        margin: auto; 
        background: white; 
        box-shadow: 0 0 10px rgba(0,0,0,0.1); 
        font-family: 'Times New Roman', Times, serif; 
        line-height: 1.3; 
    }
    
    table { border-collapse: collapse; width: 100%; border: 0.5pt solid black; margin-top: 10px; }
    
    /* ƒê√É S·ª¨A: B·ªè border m·∫∑c ƒë·ªãnh c·ªßa td ƒë·ªÉ logic ·ªü d∆∞·ªõi c√≥ t√°c d·ª•ng */
    td { padding: 8px; vertical-align: top; line-height: 1.2; }
    
    .integrated-line { display: block; margin-bottom: 2pt; }
    .img-preview-container { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
    .img-item { position: relative; width: 80px; height: 80px; border: 2px solid #3b82f6; border-radius: 8px; overflow: hidden; }
    .img-item img { width: 100%; height: 100%; object-fit: cover; }
    .btn-remove { position: absolute; top: 0; right: 0; background: #ef4444; color: white; width: 22px; height: 22px; font-size: 14px; display: flex; align-items: center; justify-content: center; cursor: pointer; border: none; font-weight: bold; border-bottom-left-radius: 6px; }
</style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, Fragment } = React;

        const App = () => {
            const [apiKey, setApiKey] = useState(localStorage.getItem("gemini_api_key") || "");
            const [loading, setLoading] = useState(false);
            const [status, setStatus] = useState("S·∫µn s√†ng");
            const [images, setImages] = useState([]); 
            const [lessonPlan, setLessonPlan] = useState(null);
	const handleApiKeyChange = (value) => {
    setApiKey(value);
    localStorage.setItem("gemini_api_key", value);
};
            
            const [tenBaiNhap, setTenBaiNhap] = useState("");
            const [monHocNhap, setMonHocNhap] = useState("");
            const [lopNhap, setLopNhap] = useState("");
            const [chuDe, setChuDe] = useState("");
            const [userPrompt, setUserPrompt] = useState("");
            const [startDate, setStartDate] = useState("");
            const [endDate, setEndDate] = useState("");
            const [baiSo, setBaiSo] = useState("");
            const [tietSo, setTietSo] = useState("");
            const [integratedContent, setIntegratedContent] = useState("");

            const fileInputRef = useRef(null);
            const cameraInputRef = useRef(null);

            const capitalizeFirstLetter = (string) => {
                if (!string) return "";
                return string.charAt(0).toUpperCase() + string.slice(1);
            };

            const formatDate = (dateStr) => {
                if (!dateStr) return ".../.../202...";
                const [y, m, d] = dateStr.split('-');
                return `${d}/${m}/${y}`;
            };

            const handleFileUpload = (e) => {
                const files = Array.from(e.target.files);
                files.forEach(file => {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        const newImg = {
                            id: Date.now() + Math.random(),
                            data: reader.result.split(',')[1],
                            preview: reader.result
                        };
                        setImages(prev => {
                            const updated = [...prev, newImg];
                            setStatus(`üì∏ ƒê√£ nh·∫≠n ${updated.length} ·∫£nh.`);
                            return updated;
                        });
                    };
                    reader.readAsDataURL(file);
                });
                e.target.value = null; // Reset input ƒë·ªÉ c√≥ th·ªÉ ch·ªçn l·∫°i c√πng 1 file n·∫øu mu·ªën
            };

            const removeImage = (id) => {
                setImages(prev => {
                    const updated = prev.filter(img => img.id !== id);
                    if (updated.length === 0) {
                        setStatus("S·∫µn s√†ng");
                    } else {
                        setStatus(`üì∏ C√≤n l·∫°i ${updated.length} ·∫£nh.`);
                    }
                    return updated;
                });
            };

            const callApiWithRetry = async (payload, retries = 3) => {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`;
                for (let i = 0; i < retries; i++) {
                    try {
                        const response = await fetch(url, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        if (response.ok) return await response.json();
                        await new Promise(res => setTimeout(res, Math.pow(2, i) * 1000));
                    } catch (e) {
                        if (i === retries - 1) throw e;
                        await new Promise(res => setTimeout(res, Math.pow(2, i) * 1000));
                    }
                }
            };

            const generateLessonPlan = async () => {
                if (!apiKey) { alert("Vui l√≤ng nh·∫≠p API Key!"); return; }
                setLoading(true);
                setStatus("üöÄ AI ƒëang so·∫°n b√†i... vui l√≤ng ƒë·ª£i.");
                
                const systemPrompt = `B·∫°n l√† chuy√™n gia so·∫°n gi√°o √°n Ti·ªÉu h·ªçc Vi·ªát Nam theo C√¥ng vƒÉn 2345.
    Tr·∫£ v·ªÅ JSON: { 
      "mon": "", 
      "bai_ten": "", 
      "yeu_cau_can_dat": { "nang_luc_dac_thu": "", "nang_luc_chung": "", "pham_chat": "" }, 
      "noi_dung_tich_hop": "",
      "do_dung": { "gv": "", "hs": "" }, 
      "hoat_dong": [ { "loai": "Kh·ªüi ƒë·ªông", "steps": [{ "gv": "", "hs": "" }] }, { "loai": "Kh√°m ph√°", "steps": [{ "gv": "", "hs": "" }] }, { "loai": "Luy·ªán t·∫≠p - Th·ª±c h√†nh", "steps": [{ "gv": "", "hs": "" }] }, { "loai": "V·∫≠n d·ª•ng", "steps": [{ "gv": "", "hs": "" }] }, { "loai": "N·ªëi ti·∫øp", "steps": [{ "gv": "", "hs": "" }] } ] 
    }
    L∆∞u √Ω quan tr·ªçng:
    - KH√îNG t·ª± ti·ªán th√™m c·ª•m t·ª´ "(Ti·∫øt ...)" v√†o t√™n b√†i d·∫°y (bai_ten). H√£y ƒë·ªÉ t√™n b√†i nguy√™n b·∫£n.
    - Cho ƒê·ªì d√πng d·∫°y h·ªçc: Tuy·ªát ƒë·ªëi KH√îNG li·ªát k√™ ph·∫•n, b·∫£ng ƒëen, m√°y t√≠nh, m√°y chi·∫øu, ti vi, SGK, v·ªü ghi. Ch·ªâ li·ªát k√™ 1-2 m√≥n c·∫ßn thi·∫øt (tranh ·∫£nh, th·∫ª t·ª´...).
    - N·∫øu c√≥ y√™u c·∫ßu t√≠ch h·ª£p trong ghi ch√∫, h√£y li·ªát k√™ c√°c n·ªôi dung t√≠ch h·ª£p v√†o 'noi_dung_tich_hop', m·ªói n·ªôi dung c√°ch nhau b·ªüi d·∫•u xu·ªëng d√≤ng (\\n). N·∫øu kh√¥ng c√≥ ghi ch√∫ v·ªÅ t√≠ch h·ª£p, ƒë·ªÉ tr·ªëng tr∆∞·ªùng n√†y.
    - Ch·ªØ c√°i ƒë·∫ßu c√¢u vi·∫øt hoa.`;

                try {
                    const promptText = `So·∫°n b√†i: ${tenBaiNhap || "Theo ·∫£nh"}. M√¥n: ${monHocNhap}. L·ªõp: ${lopNhap}. Ch·ªß ƒë·ªÅ: ${chuDe}. Ghi ch√∫: ${userPrompt}.`;
                    const parts = [{ text: promptText }];
                    images.forEach(img => parts.push({ inlineData: { mimeType: "image/png", data: img.data } }));

                    const payload = {
                        contents: [{ parts }],
                        systemInstruction: { parts: [{ text: systemPrompt }] },
                        generationConfig: { responseMimeType: "application/json", temperature: 0.1 }
                    };

                    const result = await callApiWithRetry(payload);
                    const rawText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (rawText) {
                        setLessonPlan(JSON.parse(rawText.trim()));
                        setStatus("‚úÖ Gi√°o √°n ƒë√£ so·∫°n xong!");
                    }
                } catch (error) {
                    setStatus("‚ùå L·ªói k·∫øt n·ªëi ho·∫∑c API Key.");
                } finally {
                    setLoading(false);
                }
            };

            const exportToWord = () => {
    const element = document.getElementById('lesson-plan-content');
    const header = `
        <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
        <head><meta charset='utf-8'>
        <style>
            /* C·∫•u h√¨nh trang A4 chu·∫©n B·ªô GD cho file Word */
            @page Section1 { 
                size: 595.3pt 841.9pt; 
                margin: 2cm 1.5cm 2cm 3cm; 
                mso-header-margin: 35.4pt; 
                mso-footer-margin: 35.4pt; 
                mso-paper-source: 0; 
            }
            div.Section1 { page: Section1; }
            body { font-family: 'Times New Roman'; font-size: 14pt; line-height: 1.2; }
            table { border-collapse: collapse; width: 100%; border: 0.5pt solid black; }
            td { border: 0.5pt solid black; padding: 6pt; vertical-align: top; font-size: 14pt; }
            p { margin: 0pt; margin-bottom: 3pt; }
        </style>
        </head>
        <body><div class="Section1">${element.innerHTML}</div></body></html>`;
    
    const blob = new Blob(['\ufeff', header], { type: 'application/msword' });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = `GiaoAn_${tenBaiNhap || 'Moi'}.doc`;
    link.click();
};

            const rawIntegrated = integratedContent || (lessonPlan?.noi_dung_tich_hop || "");
            const integratedLines = rawIntegrated.split('\n').filter(line => line.trim() !== "");

            return (
                <div className="max-w-5xl mx-auto my-10 p-5">
                    <div className="bg-slate-900 p-6 rounded-xl text-white shadow-2xl">
                        <h1 className="text-xl font-bold mb-6 flex items-center gap-2">üè´ AI SO·∫†N B√ÄI - TH KH√ÅNH B√åNH</h1>
                        
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <input 
    type="password" 
    placeholder="D√°n API KEY..." 
    className="p-2 rounded bg-slate-800 border border-slate-700 text-yellow-400" 
    value={apiKey} 
    onChange={e => handleApiKeyChange(e.target.value)} // Thay setApiKey b·∫±ng handleApiKeyChange
/>
                            <div className="flex gap-2">
                                <input type="text" placeholder="M√¥n..." className="p-2 rounded bg-slate-800 w-full" value={monHocNhap} onChange={e => setMonHocNhap(e.target.value)} />
                                <input type="text" placeholder="L·ªõp..." className="p-2 rounded bg-slate-800 w-full" value={lopNhap} onChange={e => setLopNhap(e.target.value)} />
                            </div>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <input type="text" placeholder="Ch·ªß ƒë·ªÅ..." className="p-2 rounded bg-slate-800" value={chuDe} onChange={e => setChuDe(e.target.value)} />
                            <input type="text" placeholder="T√™n b√†i d·∫°y..." className="p-2 rounded bg-slate-800" value={tenBaiNhap} onChange={e => setTenBaiNhap(e.target.value)} />
                            <div className="flex gap-2">
                                <input type="text" placeholder="B√†i s·ªë..." className="p-2 rounded bg-slate-800 w-full" value={baiSo} onChange={e => setBaiSo(e.target.value)} />
                                <input type="text" placeholder="Ti·∫øt..." className="p-2 rounded bg-slate-800 w-full" value={tietSo} onChange={e => setTietSo(e.target.value)} />
                            </div>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div className="flex flex-col">
                                <label className="text-xs text-slate-400 mb-1">T·ª´ ng√†y:</label>
                                <input type="date" className="p-2 rounded bg-slate-800" value={startDate} onChange={e => setStartDate(e.target.value)} />
                            </div>
                            <div className="flex flex-col">
                                <label className="text-xs text-slate-400 mb-1">ƒê·∫øn ng√†y:</label>
                                <input type="date" className="p-2 rounded bg-slate-800" value={endDate} onChange={e => setEndDate(e.target.value)} />
                            </div>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <textarea placeholder="N·ªôi dung t√≠ch h·ª£p..." className="p-2 rounded bg-slate-800 h-20" value={integratedContent} onChange={e => setIntegratedContent(e.target.value)} />
                            <textarea placeholder="Ghi ch√∫ cho AI..." className="p-2 rounded bg-slate-800 h-20" value={userPrompt} onChange={e => setUserPrompt(e.target.value)} />
                        </div>

                        {images.length > 0 && (
                            <div className="mb-4 bg-slate-800 p-3 rounded-lg">
                                <p className="text-xs text-blue-400 mb-2 font-bold uppercase tracking-wider">Danh s√°ch ·∫£nh ƒë√£ ch·ªçn:</p>
                                <div className="img-preview-container">
                                    {images.map(img => (
                                        <div key={img.id} className="img-item shadow-lg">
                                            <img src={img.preview} alt="preview" />
                                            <button className="btn-remove" title="X√≥a ·∫£nh n√†y" onClick={() => removeImage(img.id)}>‚úï</button>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        <div className="flex flex-wrap gap-3 items-center border-t border-slate-800 pt-6">
                            <button onClick={() => cameraInputRef.current.click()} className="bg-blue-600 px-4 py-3 rounded-lg hover:bg-blue-500 transition font-bold flex items-center gap-2">
                                üì∑ Ch·ª•p ·∫£nh
                            </button>
                            <button onClick={() => fileInputRef.current.click()} className="bg-slate-700 px-4 py-3 rounded-lg hover:bg-slate-600 transition font-bold">
                                üìÅ Ch·ªçn ·∫£nh
                            </button>
                            
                            <input type="file" ref={cameraInputRef} className="hidden" accept="image/*" capture="environment" onChange={handleFileUpload} />
                            <input type="file" ref={fileInputRef} className="hidden" accept="image/*" multiple onChange={handleFileUpload} />
                            
                            <button onClick={generateLessonPlan} disabled={loading} className="flex-1 bg-yellow-500 text-black font-bold px-8 py-3 rounded-lg hover:bg-yellow-400 disabled:bg-slate-500 shadow-lg">
                                {loading ? "‚è≥ ƒêang so·∫°n..." : "‚ú® So·∫°n ngay"}
                            </button>

                            {lessonPlan && (
                                <button onClick={exportToWord} className="bg-green-600 px-6 py-3 rounded-lg hover:bg-green-500 transition font-bold shadow-lg">üì• Word</button>
                            )}
                        </div>
                        <p className="text-xs mt-4 text-slate-400 font-mono italic">{status}</p>
                    </div>

                    <div className="mt-10 p-10 bg-white rounded-xl shadow-lg min-h-[500px] overflow-x-auto border border-slate-200">
                        {lessonPlan ? (
                            <div id="lesson-plan-content" className="word-content" style={{fontSize: '14pt'}}>
                                <div style={{ textAlign: 'center', marginBottom: '12pt' }}>
                                    <h2 style={{ fontWeight: 'bold', textTransform: 'uppercase', margin: '0' }}>K·∫æ HO·∫†CH B√ÄI D·∫†Y</h2>
                                    <p style={{ fontWeight: 'bold', textTransform: 'uppercase', margin: '5pt 0' }}>M√¥n: {monHocNhap || lessonPlan.mon} - L·ªõp {lopNhap}</p>
                                    {chuDe && <p style={{ fontWeight: 'bold', margin: '0' }}>Ch·ªß ƒë·ªÅ: {chuDe}</p>}
                                    <p style={{ fontWeight: 'bold', margin: '5pt 0' }}>
                                        B√ÄI {baiSo && `${baiSo}: `} {tenBaiNhap || lessonPlan.bai_ten} {tietSo && `(Ti·∫øt ${tietSo})`}
                                    </p>
                                    <p style={{ fontStyle: 'italic', margin: '0' }}>
                                        Th·ªùi gian th·ª±c hi·ªán: T·ª´ ng√†y {formatDate(startDate)} ƒë·∫øn ng√†y {formatDate(endDate)}
                                    </p>
                                </div>

                                <p style={{ fontWeight: 'bold', textTransform: 'uppercase' }}>I. Y√äU C·∫¶U C·∫¶N ƒê·∫†T</p>
{/* TH√äM textAlign: 'justify' V√ÄO ƒê√ÇY */}
<div style={{ marginLeft: '15pt', textAlign: 'justify' }}> 
    <div style={{ marginBottom: '10pt' }}>
        <strong>1. NƒÉng l·ª±c ƒë·∫∑c th√π</strong>
        <div style={{ marginLeft: '15pt', marginTop: '3pt' }}>
            {capitalizeFirstLetter(lessonPlan.yeu_cau_can_dat?.nang_luc_dac_thu)}
        </div>
    </div>
    
    <div style={{ marginBottom: '10pt' }}>
        <strong>2. NƒÉng l·ª±c chung</strong>
        <div style={{ marginLeft: '15pt', marginTop: '3pt' }}>
            {capitalizeFirstLetter(lessonPlan.yeu_cau_can_dat?.nang_luc_chung)}
        </div>
    </div>
    
    <div style={{ marginBottom: '10pt' }}>
        <strong>3. Ph·∫©m ch·∫•t</strong>
        <div style={{ marginLeft: '15pt', marginTop: '3pt' }}>
            {capitalizeFirstLetter(lessonPlan.yeu_cau_can_dat?.pham_chat)}
        </div>
    </div>

    {integratedLines.length > 0 && (
        <div style={{ marginBottom: '10pt' }}>
            <p><strong>4. N·ªôi dung t√≠ch h·ª£p:</strong></p>
            {integratedLines.map((line, idx) => (
                <span key={idx} className="integrated-line" style={{marginLeft: '15pt'}}> {line}</span>
            ))}
        </div>
    )}
</div>

                               <p style={{ fontWeight: 'bold', textTransform: 'uppercase', marginTop: '15pt' }}>II. ƒê·ªí D√ôNG D·∫†Y H·ªåC</p>

{/* TH√äM D√íNG N√ÄY ƒê·ªÇ B·∫ÆT ƒê·∫¶U CANH ƒê·ªÄU */}
<div style={{ marginLeft: '15pt', textAlign: 'justify' }}> 
    <p>- GV: {lessonPlan.do_dung?.gv}</p>
    <p>- HS: {lessonPlan.do_dung?.hs}</p>
</div> 
{/* ƒê√ìNG TH·∫∫ DIV T·∫†I ƒê√ÇY */}

                                <p style={{ fontWeight: 'bold', textTransform: 'uppercase', marginTop: '15pt' }}>III. C√ÅC HO·∫†T ƒê·ªòNG D·∫†Y H·ªåC CH·ª¶ Y·∫æU</p>
                                <table style={{ width: '100%', borderCollapse: 'collapse', border: '0.5pt solid black', borderSpacing: 0 }}>
    <thead>
        <tr style={{ backgroundColor: '#f3f4f6' }}>
            <td style={{ textAlign: 'center', fontWeight: 'bold', width: '50%', border: '0.5pt solid black', padding: '8px' }}>Ho·∫°t ƒë·ªông c·ªßa gi√°o vi√™n</td>
            <td style={{ textAlign: 'center', fontWeight: 'bold', width: '50%', border: '0.5pt solid black', padding: '8px' }}>Ho·∫°t ƒë·ªông c·ªßa h·ªçc sinh</td>
        </tr>
    </thead>
    <tbody>
        {lessonPlan.hoat_dong?.map((act, i) => (
            <Fragment key={i}>
                {/* D√≤ng ti√™u ƒë·ªÅ ho·∫°t ƒë·ªông l·ªõn */}
                <tr>
                    <td colSpan="2" style={{ fontWeight: 'bold', fontStyle: 'italic', backgroundColor: '#f9fafb', border: '0.5pt solid black', padding: '8px' }}>
                        {i+1}. Ho·∫°t ƒë·ªông {act.loai}
                    </td>
                </tr>
                
                {act.steps?.map((step, j) => (
                    <tr key={j}>
                        {/* C·ªôt Gi√°o vi√™n */}
                        <td style={{ 
                            padding: '8px', 
                            verticalAlign: 'top',
                            borderLeft: '0.5pt solid black', 
                            borderRight: '0.5pt solid black',
                            borderTop: 'none', // Tri·ªát ti√™u ƒë∆∞·ªùng k·∫ª tr√™n
                            // Ch·ªâ k·∫ª d∆∞·ªõi n·∫øu l√† b∆∞·ªõc cu·ªëi c√πng c·ªßa ho·∫°t ƒë·ªông
                            borderBottom: j === act.steps.length - 1 ? '0.5pt solid black' : 'none' 
                        }}>
                            {capitalizeFirstLetter(step.gv)}
                        </td>
                        
                        {/* C·ªôt H·ªçc sinh */}
                        <td style={{ 
                            padding: '8px', 
                            verticalAlign: 'top',
                            borderRight: '0.5pt solid black',
                            borderTop: 'none', // Tri·ªát ti√™u ƒë∆∞·ªùng k·∫ª tr√™n
                            borderBottom: j === act.steps.length - 1 ? '0.5pt solid black' : 'none'
                        }}>
                            {capitalizeFirstLetter(step.hs)}
                        </td>
                    </tr>
                ))}
            </Fragment>
        ))}
    </tbody>
</table>
			{/* M·ª§C IV ƒê∆Ø·ª¢C TH√äM ·ªû ƒê√ÇY - N·∫∞M SAU B·∫¢NG */}
    <div style={{ marginTop: '20pt' }}>
        <p style={{ fontWeight: 'bold', textTransform: 'uppercase' }}>
            IV. ƒêI·ªÄU CH·ªàNH SAU B√ÄI D·∫†Y (N·∫æU C√ì)
        </p>
        <div style={{ marginTop: '5pt' }}>
            <div style={{ borderBottom: '1pt dotted black', height: '25pt', width: '100%' }}></div>
            <div style={{ borderBottom: '1pt dotted black', height: '25pt', width: '100%' }}></div>
            <div style={{ borderBottom: '1pt dotted black', height: '25pt', width: '100%' }}></div>
        </div>
    </div>
                            </div>
                        ) : (
                            <div className="text-center text-slate-300 mt-20 italic">Nh·∫≠p d·ªØ li·ªáu v√† b·∫•m "So·∫°n ngay" ƒë·ªÉ b·∫Øt ƒë·∫ßu.</div>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>